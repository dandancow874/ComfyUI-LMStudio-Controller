# ComfyUI-LMStudio-Controller

[English](#english) | [ä¸­æ–‡](#chinese)

<a name="english"></a>
## ğŸ‡¬ğŸ‡§ English

A Custom Node for ComfyUI that integrates **LM Studio**'s CLI (`lms`) to perform Vision Language Model (VLM) inference locally. 

It allows you to use local models (like Qwen-VL, LLaVA, etc.) to analyze images directly within ComfyUI workflows.

### âœ¨ Features

*   **Smart Model Management**: automatically unloads the previous model and loads the new one when you switch models in the dropdown.
*   **VRAM Friendly**: Includes an "Unload After" option to free up GPU memory immediately after generation.
*   **Full Parameter Control**: Supports Temperature, Top P, Top K, Repetition Penalty, etc.
*   **CLI Integration**: Automatically fetches your downloaded models from LM Studio using `lms ls`.
*   **Clean UI**: Filters out system text from the model list for a clean selection experience.

### âš™ï¸ Prerequisites (Important)

1.  **Install LM Studio**: Download from [lmstudio.ai](https://lmstudio.ai/).
2.  **Install the CLI Tool**: 
    *   Open LM Studio.
    *   Go to the **"Developer"** tab (or Settings).
    *   Click **"Install lms to PATH"** (or ensure `lms` command works in your terminal).
3.  **Start Local Server**:
    *   In LM Studio, go to the **"Local Server"** tab.
    *   **Start the Server** (Default port: 1234).
    *   *Note: This node uses the CLI to load models, but the API request is sent to the local server port.*

### ğŸ“¥ Installation

1.  Navigate to your ComfyUI custom nodes directory:
    ```bash
    cd ComfyUI/custom_nodes/
    ```
2.  Clone this repository:
    ```bash
    git clone https://github.com/dandancow874/ComfyUI-LMStudio-Controller.git
    ```
3.  Install dependencies:
    ```bash
    pip install -r requirements.txt
    ```
4.  Restart ComfyUI.

### ğŸš€ Usage

1.  Search for the node **"LM Studio Vision Controller"**.
2.  Connect an image and a prompt.
3.  **Model Name**: Select a vision model from the dropdown (list is fetched from your LM Studio downloads).
4.  **Unload After**: Check this if you want to release VRAM immediately after the task.

---

<a name="chinese"></a>
## ğŸ‡¨ğŸ‡³ ä¸­æ–‡è¯´æ˜

è¿™æ˜¯ä¸€ä¸ª ComfyUI è‡ªå®šä¹‰èŠ‚ç‚¹ï¼Œé€šè¿‡é›†æˆ **LM Studio** çš„å‘½ä»¤è¡Œå·¥å…· (`lms`)ï¼Œå®ç°æœ¬åœ°è§†è§‰å¤§æ¨¡å‹ (VLM) çš„æ¨ç†ã€‚

å®ƒå…è®¸ä½ åœ¨ ComfyUI å·¥ä½œæµä¸­ç›´æ¥è°ƒç”¨æœ¬åœ°æ¨¡å‹ï¼ˆå¦‚ Qwen-VL, LLaVA ç­‰ï¼‰æ¥è¯†åˆ«å’Œæè¿°å›¾åƒã€‚

### âœ¨ ä¸»è¦åŠŸèƒ½

*   **æ™ºèƒ½æ¨¡å‹ç®¡ç†**ï¼šåœ¨ä¸‹æ‹‰èœå•åˆ‡æ¢æ¨¡å‹æ—¶ï¼Œè‡ªåŠ¨æ£€æµ‹å¹¶å¸è½½æ—§æ¨¡å‹ï¼ŒåŠ è½½æ–°æ¨¡å‹ã€‚
*   **æ˜¾å­˜å‹å¥½**ï¼šæä¾› "Unload After"ï¼ˆè¿è¡Œåå¸è½½ï¼‰é€‰é¡¹ï¼Œç”Ÿæˆå®Œæˆåç«‹å³é‡Šæ”¾æ˜¾å­˜ã€‚
*   **å‚æ•°å…¨æŒæ§**ï¼šæ”¯æŒè°ƒèŠ‚ Temperature, Top P, Top K, é‡å¤æƒ©ç½š (Repetition Penalty) ç­‰å‚æ•°ã€‚
*   **CLI æ·±åº¦é›†æˆ**ï¼šé€šè¿‡ `lms ls` è‡ªåŠ¨è·å–ä½ æœ¬åœ°ä¸‹è½½çš„æ‰€æœ‰æ¨¡å‹åˆ—è¡¨ã€‚
*   **åˆ—è¡¨è‡ªåŠ¨æ¸…æ´—**ï¼šè‡ªåŠ¨è¿‡æ»¤æ‰æ— å…³çš„ç³»ç»Ÿæ–‡æœ¬ï¼Œåªæ˜¾ç¤ºæ¸…æ™°çš„æ¨¡å‹åç§°ã€‚

### âš™ï¸ å‰ç½®è¦æ±‚ (é‡è¦)

1.  **å®‰è£… LM Studio**: è¯·å‰å¾€ [lmstudio.ai](https://lmstudio.ai/) ä¸‹è½½ã€‚
2.  **å¯ç”¨ CLI å·¥å…·**: 
    *   æ‰“å¼€ LM Studioã€‚
    *   è¿›å…¥ **"Developer" (å¼€å‘è€…)** é€‰é¡¹å¡ï¼ˆæˆ–è®¾ç½®é¡µé¢ï¼‰ã€‚
    *   ç‚¹å‡» **"Install lms to PATH"**ï¼ˆç¡®ä¿åœ¨ç»ˆç«¯è¾“å…¥ `lms` èƒ½çœ‹åˆ°è¾“å‡ºï¼‰ã€‚
3.  **å¯åŠ¨æœ¬åœ°æœåŠ¡ (Local Server)**:
    *   åœ¨ LM Studio ä¸­ï¼Œç‚¹å‡»å·¦ä¾§çš„ **"Local Server"** å›¾æ ‡ã€‚
    *   ç‚¹å‡» **"Start Server"** (é»˜è®¤ç«¯å£ 1234)ã€‚
    *   *æ³¨æ„ï¼šæœ¬èŠ‚ç‚¹ä½¿ç”¨ CLI åŠ è½½æ¨¡å‹ï¼Œä½†é€šè¿‡ API ç«¯å£å‘é€å›¾åƒè¯·æ±‚ï¼Œæ‰€ä»¥æœåŠ¡å¿…é¡»å¤„äºå¼€å¯çŠ¶æ€ã€‚*

### ğŸ“¥ å®‰è£…æ–¹æ³•

1.  è¿›å…¥ä½ çš„ ComfyUI è‡ªå®šä¹‰èŠ‚ç‚¹ç›®å½•ï¼š
    ```bash
    cd ComfyUI/custom_nodes/
    ```
2.  å…‹éš†æœ¬é¡¹ç›®ï¼š
    ```bash
    git clone https://github.com/dandancow874/ComfyUI-LMStudio-Controller.git
    ```
3.  å®‰è£…ä¾èµ–ï¼š
    ```bash
    pip install -r requirements.txt
    ```
4.  é‡å¯ ComfyUIã€‚

### ğŸš€ ä½¿ç”¨æŒ‡å—

1.  åœ¨ ComfyUI ä¸­æœç´¢èŠ‚ç‚¹ **"LM Studio Vision Controller"**ã€‚
2.  è¿æ¥å›¾åƒ (Image) å’Œæç¤ºè¯ (Prompt)ã€‚
3.  **Model Name**: ä»ä¸‹æ‹‰èœå•ä¸­é€‰æ‹©ä¸€ä¸ªè§†è§‰æ¨¡å‹ï¼ˆåˆ—è¡¨ä¼šè‡ªåŠ¨åŒæ­¥ LM Studio ä¸­å·²ä¸‹è½½çš„æ¨¡å‹ï¼‰ã€‚
4.  **Unload After**: å¦‚æœä½ çš„æ˜¾å­˜ç´§å¼ ï¼Œå»ºè®®å¼€å¯æ­¤é€‰é¡¹ï¼Œå®ƒä¼šåœ¨ä»»åŠ¡å®Œæˆåè‡ªåŠ¨å¸è½½æ¨¡å‹ã€‚

---