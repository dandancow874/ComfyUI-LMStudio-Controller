ComfyUI-LMStudio-Controller

English | ä¸­æ–‡

<a name="english"></a>
ğŸ‡¬ğŸ‡§ English

A powerful Custom Node for ComfyUI that integrates LM Studio's CLI (lms) to perform Vision Language Model (VLM) inference locally.

It upgrades your ComfyUI with the ability to "see" images and videos using local models (like Qwen2-VL, LLaVA, etc.), with advanced memory management to prevent OOM errors on consumer GPUs.
âœ¨ Key Features

    ğŸ¬ Video Analysis Support: Seamlessly integrates with VideoHelperSuite (VHS) to analyze video frames.

    ğŸ–¼ï¸ Multi-Input Interface: Supports main image, auxiliary images (Image 2/3), and video frame inputs simultaneously.

    ğŸ›¡ï¸ Anti-OOM Protection:

        Smart Downsampling: Automatically downsamples input frames to max_total_images limit to fit context window.

        Resolution Control: Resizes large images/video frames (max_image_side) before sending to VLM.

        GPU Offload Control: Manually adjust how many model layers are loaded to VRAM (0.0 - 1.0) to prevent system crashes.

        Context Length Control: Set explicit context limits to manage VRAM usage.

    ğŸš€ Smart Model Management: Automatically unloads the previous model and loads the new one only when parameters change.

    CLI Integration: Automatically fetches your downloaded models from LM Studio using lms ls.

âš™ï¸ Prerequisites (Important)

    Install LM Studio: Download from lmstudio.ai.

    Install the CLI Tool:

        Open LM Studio.

        Go to the "Developer" tab (or Settings).

        Click "Install lms to PATH" (Verify by running lms in your terminal).

    Start Local Server:

        In LM Studio, go to the "Local Server" tab.

        Start the Server (Default port: 1234).

        Note: This node uses the CLI to load models, but the API request is sent to the local server port.

ğŸ“¥ Installation

    Navigate to your ComfyUI custom nodes directory:
    code Bash

    
cd ComfyUI/custom_nodes/

  

Clone this repository:
code Bash

    
git clone https://github.com/dandancow874/ComfyUI-LMStudio-Controller.git

  

Install dependencies:
code Bash

        
    pip install -r requirements.txt

      

    Restart ComfyUI.

ğŸ“– Usage Guide
1. Basic Image Analysis

Simply connect your Load Image node to the image (or image_2/image_3) input.
2. Video Analysis Workflow (Recommended)

To analyze videos, it is recommended to use the VideoHelperSuite (VHS) nodes.

    Add a Load Video (Upload) node (from VHS).

    Set force_size to Custom (e.g., 512x512 or 768x768) to save VRAM.

    Set frame_load_cap to reasonable limit (e.g., 32 or 64).

    Connect the IMAGE output of VHS to the video_frames input of this node.

    The node will automatically sample frames based on your max_total_images setting.

ğŸ› ï¸ Recommended Settings
Hardware/Model	GPU Offload	Context Length	Max Image Side	Notes
8B Models (e.g., Qwen2-VL-7B)	1.0 (Max)	16384	768 or 1024	Fast, handles high-res images well.
30B+ Models (Low VRAM)	0.6 - 0.8	4096	512	Prevents blue screen/OOM .
30B+ Models (24GB+ VRAM)	0.8 - 1.0	8192	768	Balance between quality and memory.

<a name="chinese"></a>
ğŸ‡¨ğŸ‡³ ä¸­æ–‡è¯´æ˜

è¿™æ˜¯ä¸€ä¸ªåŠŸèƒ½å¼ºå¤§çš„ ComfyUI è‡ªå®šä¹‰èŠ‚ç‚¹ï¼Œé€šè¿‡é›†æˆ LM Studio çš„å‘½ä»¤è¡Œå·¥å…· (lms)ï¼Œå®ç°æœ¬åœ°è§†è§‰å¤§æ¨¡å‹ (VLM) çš„æ¨ç†ã€‚

å®ƒä¸ä»…è®© ComfyUI èƒ½å¤Ÿâ€œçœ‹æ‡‚â€å›¾ç‰‡å’Œè§†é¢‘ï¼ˆæ”¯æŒ Qwen2-VL, LLaVA ç­‰ï¼‰ï¼Œè¿˜å¼•å…¥äº†é«˜çº§çš„æ˜¾å­˜ç®¡ç†æœºåˆ¶ï¼Œé˜²æ­¢åœ¨æ¶ˆè´¹çº§æ˜¾å¡ä¸Šè¿è¡Œå¤§å‚æ•°æ¨¡å‹æ—¶å‘ç”Ÿçˆ†æ˜¾å­˜ï¼ˆOOMï¼‰æˆ–è“å±ã€‚
âœ¨ ä¸»è¦åŠŸèƒ½

    ğŸ¬ è§†é¢‘ç†è§£æ”¯æŒï¼šå®Œç¾é…åˆ VideoHelperSuite (VHS) èŠ‚ç‚¹ï¼Œæ¥æ”¶è§†é¢‘æµå¹¶è¿›è¡Œåæ¨/åˆ†æã€‚

    ğŸ–¼ï¸ å¤šæ¨¡æ€è¾“å…¥æ¥å£ï¼šæ”¯æŒä¸»å›¾ã€ä¸¤å¼ è¾…åŠ©å›¾ (Image 2/3) ä»¥åŠè§†é¢‘å¸§ (Video Frames) åŒæ—¶è¾“å…¥ã€‚

    ğŸ›¡ï¸ é˜²çˆ†æ˜¾å­˜æœºåˆ¶ (æ ¸å¿ƒåŠŸèƒ½)ï¼š

        æ™ºèƒ½æŠ½å¸§ï¼šæ— è®ºè¾“å…¥å¤šå°‘è§†é¢‘å¸§ï¼Œè‡ªåŠ¨æ ¹æ® max_total_images è¿›è¡Œå‡åŒ€é‡‡æ ·ï¼Œé˜²æ­¢ Token æº¢å‡ºã€‚

        åˆ†è¾¨ç‡æ§åˆ¶ï¼šé€šè¿‡ max_image_side é™åˆ¶è¾“å…¥ç»™æ¨¡å‹çš„å›¾ç‰‡å°ºå¯¸ï¼Œå¤§å¹…é™ä½æ˜¾å­˜å ç”¨ã€‚

        GPU Offload æ§åˆ¶ï¼šæ”¯æŒæ‰‹åŠ¨è°ƒèŠ‚æ¨¡å‹åŠ è½½åˆ°æ˜¾å­˜çš„æ¯”ä¾‹ (0.0 - 1.0)ã€‚30B å¤§æ¨¡å‹å»ºè®®è®¾ä¸º 0.8 ä»¥é˜²è“å±ã€‚

        Context Length æ§åˆ¶ï¼šæ˜¾å¼é™åˆ¶æ¨¡å‹çš„ä¸Šä¸‹æ–‡çª—å£å¤§å°ã€‚

    ğŸš€ æ™ºèƒ½åŠ è½½ï¼šä»…å½“æ¨¡å‹åç§°æˆ–å…³é”®æ˜¾å­˜å‚æ•°å˜åŒ–æ—¶æ‰è§¦å‘é‡è½½ã€‚

    åˆ—è¡¨è‡ªåŠ¨æ¸…æ´—ï¼šé€šè¿‡ lms ls è‡ªåŠ¨è·å–æ¨¡å‹åˆ—è¡¨ï¼Œå¹¶è¿‡æ»¤æ‰ç³»ç»Ÿæ‚ä¹±æ–‡æœ¬ã€‚

âš™ï¸ å‰ç½®è¦æ±‚ (é‡è¦)

    å®‰è£… LM Studio: è¯·å‰å¾€ lmstudio.ai ä¸‹è½½ã€‚

    å¯ç”¨ CLI å·¥å…·:

        æ‰“å¼€ LM Studioã€‚

        è¿›å…¥ "Developer" (å¼€å‘è€…) é€‰é¡¹å¡ï¼ˆæˆ–è®¾ç½®é¡µé¢ï¼‰ã€‚

        ç‚¹å‡» "Install lms to PATH"ï¼ˆç¡®ä¿åœ¨ç»ˆç«¯è¾“å…¥ lms èƒ½çœ‹åˆ°è¾“å‡ºï¼‰ã€‚

    å¯åŠ¨æœ¬åœ°æœåŠ¡ (Local Server):

        åœ¨ LM Studio ä¸­ï¼Œç‚¹å‡»å·¦ä¾§çš„ "Local Server" å›¾æ ‡ã€‚

        ç‚¹å‡» "Start Server" (é»˜è®¤ç«¯å£ 1234)ã€‚

        æ³¨æ„ï¼šæœ¬èŠ‚ç‚¹ä¾èµ– Local Server æ¥æ”¶å›¾åƒ API è¯·æ±‚ã€‚

ğŸ“¥ å®‰è£…æ–¹æ³•

    è¿›å…¥ä½ çš„ ComfyUI è‡ªå®šä¹‰èŠ‚ç‚¹ç›®å½•ï¼š
    code Bash

    
cd ComfyUI/custom_nodes/

  

å…‹éš†æœ¬é¡¹ç›®ï¼š
code Bash

    
git clone https://github.com/dandancow874/ComfyUI-LMStudio-Controller.git

  

å®‰è£…ä¾èµ–ï¼š
code Bash

        
    pip install -r requirements.txt

      

    é‡å¯ ComfyUIã€‚

ğŸ“– ä½¿ç”¨æŒ‡å—
1. åŸºç¡€å›¾ç‰‡åˆ†æ

å°† Load Image èŠ‚ç‚¹è¿æ¥åˆ°æœ¬èŠ‚ç‚¹çš„ image (æˆ– image_2/image_3) ç«¯å£å³å¯ã€‚
2. è§†é¢‘åæ¨å·¥ä½œæµ (æ¨è)

å»ºè®®é…åˆ VideoHelperSuite (VHS) æ’ä»¶ä½¿ç”¨ï¼š

    æ·»åŠ  Load Video (Upload) èŠ‚ç‚¹ (VHS)ã€‚

    å…³é”®è®¾ç½®ï¼šå°† force_size è®¾ä¸º Custom (ä¾‹å¦‚ 512x512 æˆ– 768x768)ï¼Œè¿™ä¸€æ­¥æœ€çœæ˜¾å­˜ã€‚

    å°† frame_load_cap è®¾ä¸ºé€‚å½“å€¼ (å¦‚ 32 æˆ– 64)ã€‚

    å°† VHS çš„ IMAGE è¾“å‡ºè¿æ¥åˆ°æœ¬èŠ‚ç‚¹çš„ video_frames ç«¯å£ã€‚

    æœ¬èŠ‚ç‚¹ä¼šè‡ªåŠ¨æ ¹æ®ä½ è®¾ç½®çš„ max_total_images (å¦‚ 8) å¯¹è§†é¢‘è¿›è¡Œå‡åŒ€æŠ½å¸§ã€‚

ğŸ› ï¸ æ¨èå‚æ•°è®¾ç½®
ç¡¬ä»¶/æ¨¡å‹æƒ…å†µ	GPU Offload	Context Length	Max Image Side	è¯´æ˜
8B å°æ¨¡å‹ (å¦‚ Qwen2-VL-7B)	1.0 (æ‹‰æ»¡)	16384	768 æˆ– 1024	é€Ÿåº¦å¿«ï¼Œå¯å¤„ç†é«˜æ¸…å›¾ï¼Œæ˜¾å­˜æ— å‹åŠ›ã€‚
30B+ å¤§æ¨¡å‹ (æ˜¾å­˜ç´§å¼ )	0.6 - 0.8	4096	512	é˜²æ­¢è“å±çš„å…³é”®é…ç½®ã€‚
30B+ å¤§æ¨¡å‹ (24Gæ˜¾å­˜)	0.8 - 1.0	8192	768	ç”»è´¨ä¸æ˜¾å­˜çš„å¹³è¡¡ç‚¹ã€‚
